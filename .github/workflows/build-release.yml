name: Build and Release

on:
  push:
    branches:
      - master
      - main
      - dev
      - 'feature/**'
      - 'beta/**'
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
      - 'docs/**'
      - '*.txt'
      - 'example_config.yaml'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for commit count

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install PyQt6 opencv-python numpy pyqtgraph pyyaml
          # CPU PyTorch - smaller/faster download for CI
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          pip install easyocr

      - name: Get version info
        id: version
        run: |
          # Count commits for build number
          $commitCount = git rev-list --count HEAD
          $shortSha = $env:GITHUB_SHA.Substring(0,7)
          $branch = "${{ github.ref_name }}"
          
          # Determine if this is a beta release
          $isBeta = ($branch -ne "master") -and ($branch -ne "main")
          
          if ($isBeta) {
            # Beta version includes branch name
            $safeBranch = $branch -replace '[^a-zA-Z0-9]', '-'
            $version = "1.0.$commitCount-beta.$safeBranch"
            $tag = "v1.0.$commitCount-beta.$safeBranch"
            $exeName = "FB_Data_Scraper_v1.0.${commitCount}_beta_${safeBranch}.exe"
          } else {
            # Stable version
            $version = "1.0.$commitCount"
            $tag = "v1.0.$commitCount"
            $exeName = "FB_Data_Scraper_v$version.exe"
          }
          
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "exe_name=$exeName" >> $env:GITHUB_OUTPUT
          echo "short_sha=$shortSha" >> $env:GITHUB_OUTPUT
          echo "is_beta=$isBeta" >> $env:GITHUB_OUTPUT
          echo "Building version: $version (beta: $isBeta)"

      - name: Build executable
        run: |
          pyinstaller fsae_extractor.spec --clean
          # Rename exe
          $exeName = "${{ steps.version.outputs.exe_name }}"
          Move-Item "dist/FB_Data_Scraper.exe" "dist/$exeName"

      - name: Get current date
        id: date
        run: |
          echo "date=$(Get-Date -Format 'yyyy-MM-dd')" >> $env:GITHUB_OUTPUT

      - name: Create Stable Release
        if: steps.version.outputs.is_beta == 'False'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "FB Data Scraper v${{ steps.version.outputs.version }}"
          body: |
            ## ğŸš€ FB Data Scraper v${{ steps.version.outputs.version }}
            
            **Commit:** `${{ steps.version.outputs.short_sha }}`
            **Date:** ${{ steps.date.outputs.date }}
            
            ### ğŸ“¥ Download
            Download `${{ steps.version.outputs.exe_name }}` below and run it - no installation required!
            
            ### â„¹ï¸ Note
            This is a **CPU build** for portability. For GPU acceleration, build from source with CUDA PyTorch.
          files: |
            dist/${{ steps.version.outputs.exe_name }}
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Beta Release
        if: steps.version.outputs.is_beta == 'True'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "ğŸ§ª FB Data Scraper v${{ steps.version.outputs.version }}"
          body: |
            ## ğŸ§ª BETA: FB Data Scraper v${{ steps.version.outputs.version }}
            
            **âš ï¸ This is a beta/development build - may be unstable!**
            
            **Branch:** `${{ github.ref_name }}`
            **Commit:** `${{ steps.version.outputs.short_sha }}`
            **Date:** ${{ steps.date.outputs.date }}
            
            ### ğŸ“¥ Download
            Download `${{ steps.version.outputs.exe_name }}` below to test new features.
            
            ### â„¹ï¸ Note
            This is a **beta build** from branch `${{ github.ref_name }}`. 
            For stable releases, check the [latest stable release](../../releases/latest).
          files: |
            dist/${{ steps.version.outputs.exe_name }}
          prerelease: true
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
